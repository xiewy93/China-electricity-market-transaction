# -*- coding: utf-8 -*-
"""
Created on Sun Apr 23 17:58:00 2017

@author: xie
"""

#第一轮为集合竞价
#输入 list 电量+电价
#第二轮为双摘
import pandas as pd
import copy 
import matplotlib.pyplot as plt


class  set_auction():
    def __init__(self,input_sell,input_buy):
        self.input_sell=input_sell
        self.input_buy = input_buy
        
    
    def get_append(self,x):
        temp=[]
        temp2=[]
        for i in x['userid']:
            temp.append(i)
        for j in x['quantity']:
            temp2.append(j)
        return temp,temp2   
        
    def pre_data(self):
        self.df_buy=self.input_buy.price.abs()
        self.df_buy= self.input_buy.groupby('price').agg(lambda x:self.get_append(x))
        self.df_buy['count']=self.input_buy.groupby('price')['quantity'].count()
        self.df_buy['sum_quantity']=self.input_buy.groupby('price')['quantity'].sum()
        self.df_buy=self.df_buy.reset_index()
        self.df_buy=self.df_buy.sort_values('price',ascending=False)
        
        self.df_sell=self.input_sell.price.abs()
        self.df_sell = self.input_sell.groupby('price').agg(lambda x:self.get_append(x))
        self.df_sell['count']=self.input_sell.groupby('price')['quantity'].count()
        self.df_sell['sum_quantity']=self.input_sell.groupby('price')['quantity'].sum()
        self.df_sell=self.df_sell.reset_index()
        self.df_sell=self.df_sell.sort_values('price',ascending=True)
        buy_data=pd.DataFrame(self.df_buy)
        sell_data=pd.DataFrame(self.df_sell)
        buy_data.columns=['buy_price','buy_userid','buy_quantity','user_count','sum_quantity']
        sell_data.columns=['sell_price','sell_userid','sell_quantity','user_count','sum_quantity']
        return buy_data,sell_data
        
    def compute(self):
        df_buy,df_sell=self.pre_data()
        i=j=0
        pair=[]
        buy_sum_quantity=copy.deepcopy(list(df_buy.sum_quantity))
        sell_sum_quantity=copy.deepcopy(list(df_sell.sum_quantity))
        while list(df_buy.buy_price)[i]>=list(df_sell.sell_price)[j]:
            if buy_sum_quantity[i]>sell_sum_quantity[j]:
                pair.append([list(df_buy.buy_price)[i],list(df_sell.sell_price)[j],sell_sum_quantity[j]])
                buy_sum_quantity[i]=buy_sum_quantity[i]-sell_sum_quantity[j]
                j=j+1
            elif buy_sum_quantity[i]<sell_sum_quantity[j]:
                pair.append([list(df_buy.buy_price)[i],list(df_sell.sell_price)[j],buy_sum_quantity[i]])
                sell_sum_quantity[j]=sell_sum_quantity[j]-buy_sum_quantity[i]
                i=i+1
            else:
                pair.append([list(df_buy.buy_price)[i],list(df_sell.sell_price)[j],sell_sum_quantity[i]])
                j=j+1
                i=i+1       
        df=pd.DataFrame(pair,columns=['buy_price','sell_price','deal_quantity'])        
        return df

    def assign_quantity(self):
        df=self.compute()
        df_buy,df_sell=self.pre_data()
        buy_deal=pd.merge(df,df_buy,on='buy_price')
        sell_deal=pd.merge(df,df_sell,on='sell_price')
        assign_buy_quantity_result=copy.deepcopy(buy_deal[['buy_price','sell_price','deal_quantity','buy_userid']])
        assign_sell_quantity_result=copy.deepcopy(sell_deal[['buy_price','sell_price','deal_quantity','sell_userid']])
        assign_buy_quantity=[]
        assign_sell_quantity=[]
        for i in range(len(buy_deal)):
            assign_buy_quantity.append([buy_deal.deal_quantity[i]*x/sum(buy_deal.buy_quantity[i]) for x in buy_deal.buy_quantity[i]])
            assign_sell_quantity.append([sell_deal.deal_quantity[i]*x/sum(sell_deal.sell_quantity[i]) for x in sell_deal.sell_quantity[i]])
        
        assign_buy_quantity_result['assign_buy_quantity']=assign_buy_quantity
        assign_sell_quantity_result['assign_sell_quantity']=assign_sell_quantity
        return assign_buy_quantity_result,assign_sell_quantity_result
        
    def mean_voidance(self):
        buy_mean_voidance_result,sell_mean_voidance_result=self.assign_quantity()
        mean_voidance_buy_price=((buy_mean_voidance_result.buy_price+sell_mean_voidance_result.sell_price)/2)
        buy_mean_voidance_result['mean_voidance_price']=pd.Series(mean_voidance_buy_price)  
        sell_mean_voidance_result['mean_voidance_price']=pd.Series(mean_voidance_buy_price)
        return buy_mean_voidance_result,sell_mean_voidance_result
        

    def undeal(self):
        assign_buy_quantity_result,assign_sell_quantity_result=self.assign_quantity()
        buy_data,sell_data=self.pre_data()
        buy_quantity=list(copy.deepcopy(buy_data['buy_quantity']))
        i=j=0
        for k in range(len(buy_quantity)):
            if sum(buy_quantity[i])>sum(assign_buy_quantity_result.assign_buy_quantity[j]):
                buy_quantity[i]=list( map(lambda x: x[0]-x[1], zip(buy_quantity[i], assign_buy_quantity_result.assign_buy_quantity[j])))
                j=j+1
            else:
                 buy_quantity[i]=list( map(lambda x: x[0]-x[1], zip(buy_quantity[i], assign_buy_quantity_result.assign_buy_quantity[j])))
                 i=i+1
                 j=j+1
        buy_data['undeal_sum_quantity']=list([sum(buy_quantity[i]) for i in range(len(buy_quantity))])
        buy_data['undeal_quantity']=buy_quantity
        df=buy_data[(buy_data.undeal_sum_quantity > 0)]

        sell_quantity=list(copy.deepcopy(sell_data['sell_quantity']))
        i=j=0
        for k in range(len(sell_quantity)):
            if sum(sell_quantity[i])>sum(assign_sell_quantity_result.assign_sell_quantity[j]):
                sell_quantity[i]=list( map(lambda x: x[0]-x[1], zip(sell_quantity[i], assign_sell_quantity_result.assign_sell_quantity[j])))
                j=j+1
            else:
                 sell_quantity[i]=list( map(lambda x: x[0]-x[1], zip(sell_quantity[i], assign_sell_quantity_result.assign_sell_quantity[j])))
                 i=i+1
                 j=j+1
        sell_data['undeal_sum_quantity']=list([sum(sell_quantity[i]) for i in range(len(sell_quantity))])
        sell_data['undeal_quantity']=sell_quantity
        df2=sell_data[(sell_data.undeal_sum_quantity > 0)]
        return df,df2


    def return_price_margin_voidance(self):
        assign_buy_quantity_result,assign_sell_quantity_result=self.assign_quantity()
        buy_userid=list(set(list(self.input_buy.userid)))
        sell_userid=list(set(list(self.input_sell.userid)))
        Q=assign_buy_quantity_result.deal_quantity.sum()
        beta=0.25
        pair=[]
        pair2=[]
        buy_quantity=[0]*len(buy_userid)
        sell_quantity=[0]*len(sell_userid)
        buy_deal_price=[[] for i in range(len(buy_userid))]
        sell_deal_price=[[] for i in range(len(sell_userid))]
        for i in range(len(assign_buy_quantity_result)):
            pair.append([assign_buy_quantity_result.buy_userid[i],[x*assign_buy_quantity_result.buy_price[i] for x in assign_buy_quantity_result.assign_buy_quantity[i]],assign_buy_quantity_result.buy_price[i]])
            for j in range(len(buy_userid)):
               if buy_userid[j] in pair[i][0]:
                   quantity_index=pair[i][0].index(buy_userid[j])
                   buy_quantity[j]=buy_quantity[j]+pair[i][1][quantity_index]
                   buy_deal_price[j].append(pair[i][2])
                   
        for i in range(len(assign_sell_quantity_result)):
            pair2.append([assign_sell_quantity_result.sell_userid[i],[x*assign_sell_quantity_result.sell_price[i] for x in assign_sell_quantity_result.assign_sell_quantity[i]],assign_sell_quantity_result.sell_price[i]])
            for j in range(len(sell_userid)):
               if sell_userid[j] in pair2[i][0]:
                   quantity_index=pair2[i][0].index(sell_userid[j])
                   sell_quantity[j]=sell_quantity[j]+pair2[i][1][quantity_index]
                   sell_deal_price[j].append(pair2[i][2])
                   
        sell_mean_price_gap=abs(sum(sell_quantity))/Q
        buy_mean_price_gap=abs(sum(buy_quantity))/Q
        sell_deal_coefficient=(1-beta)*sell_mean_price_gap/buy_mean_price_gap+beta
        buy_deal_coefficient=beta*sell_mean_price_gap/buy_mean_price_gap+(1-beta)
        
        sell=[]
        for i in range(len(sell_deal_price)):
            a=sell_deal_price[i]
            sell.append([x*sell_deal_coefficient for x in a])
        buy=[]
        for i in range(len(buy_deal_price)):
            a=buy_deal_price[i]
            buy.append([x*buy_deal_coefficient for x in a])
        df=pd.DataFrame(buy,index=buy_userid)
        df2=pd.DataFrame(sell,index=sell_userid)
        return df,df2
    

    def unified_voidance(self):
        buy_mean_voidance_result,sell_mean_voidance_result=self.mean_voidance()
        assign_buy_quantity_result,assign_sell_quantity_result=self.assign_quantity()
        unified_price=list(buy_mean_voidance_result.mean_voidance_price)[-1]
        assign_buy_quantity_result['unified_voidance']=list([unified_price for i in range(len(assign_buy_quantity_result))])
        assign_sell_quantity_result['unified_voidance']=list([unified_price for i in range(len(assign_sell_quantity_result))])
        return assign_buy_quantity_result,assign_sell_quantity_result
        
        
      
    def get_picture(self):
        buy_data,sell_data=self.pre_data()
        buy_price=list(buy_data.buy_price)
        buy_price.insert(0,0)
        buy_sum_quantity=buy_data.sum_quantity
        sell_price=list(sell_data.sell_price)
        sell_price.insert(0,0)
        sell_sum_quantity=sell_data.sum_quantity
        x=[sum(buy_sum_quantity[:i]) for i in range(len(buy_sum_quantity)+1)]
        y=[sum(sell_sum_quantity[:i]) for i in range(len(sell_sum_quantity)+1)]
        plt.plot(x, buy_price, linestyle=':', drawstyle='steps')
        plt.plot(y, sell_price, linestyle='--', drawstyle='steps')
        plt.xlim(0.0, max(x[-1],y[-1]))
        return plt.show()
       
#if __name__=='__main__':
#    input_sell=pd.DataFrame(
#                [['sell_3',0.26,250],
#                ['sell_2',0.25,400],
#                ['sell_3',0.25,300],
#                ['sell_1',0.24,200],
#                ['sell_2',0.24,300],
#                ['sell_1',0.23,100]])
#    input_sell.columns=['userid','price','quantity']
#    input_buy=pd.DataFrame(
#            [['buy_3',0.26, 250],
#            ['buy_2',0.25, 400],
#            ['buy_3',0.25, 300],
#            ['buy_1',0.24, 200],
#            ['buy_2',0.24, 300],
#            ['buy_1',0.23, 100]])
#    input_buy.columns=['userid','price','quantity']

   
#
#if __name__=='__main__':
#    input_sell=pd.DataFrame(
#                [['sell_3',-0.26,250],
#                ['sell_2',-0.25,400],
#                ['sell_3',-0.25,300],
#                ['sell_1',-0.24,200],
#                ['sell_2',-0.24,300],
#                ['sell_1',-0.23,100]])
#    input_sell.columns=['userid','price','quantity']
#    input_buy=pd.DataFrame(
#            [['buy_3',-0.26, 250],
#            ['buy_2',-0.25, 400],
#            ['buy_3',-0.25, 300],
#            ['buy_1',-0.24, 200],
#            ['buy_2',-0.24, 300],
#            ['buy_1',-0.23, 100]])
#    input_buy.columns=['userid','price','quantity']
#
#        
#    pre_auction=set_auction(input_sell,input_buy)
#    buy_data,sell_data=pre_auction.pre_data()
#    df=pre_auction.compute()
#    assign_buy_quantity_result,assign_sell_quantity_result=pre_auction.assign_quantity()
#    buy_mean_voidance_result,sell_mean_voidance_result=pre_auction.mean_voidance()
#    e=pre_auction.unifiled_voidance()
#    d=pre_auction.undeal()
#    pre_auction.get_picture()
